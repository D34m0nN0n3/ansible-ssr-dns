# Инструкция сменного персонала DNS

??? abstract
    1. [Общее описание](#общее-описание)
    2. [Диагностика](#проверка-работоспособности)
    3. [Устранение сбоя](#устранение-сбоя)

## Общее описание

## Проверка работоспособности

### 1. Необходимо проверить доступность и сбор метрик в Grafana.
   
   1.1. Сервер доступен
   ![pg-good](images/pg-work.png)
   Если сервер доступен необходимо выполнить [разрешение имен](#3).
   
   1.2. Сервер не доступен
   ![pg-bad](images/pg-nowork.png)
   Если сервер не доступен следует проверить проверить доступность по сети и зайти на сервер по SSH, и проверить состояние сервиса. При недоступности по сети проверить состояние сервера или виртуальной машины, должна находится в статусе `PowerOn`.
   
   1.3. Убедившись в возобновление доступности
   ![pg-fix](images/pg-fix.png)
   Необходимо выполнить [разрешение имен](#3).

### 2. Проверка состояния сервиса.

Для проверки необходимо запустить сценарий проверки: `named-healthy-check`. Так как сервис может быть запушен в разных режимах с подменой дерева каталогов (unit name: named-chroot.service) или без (unit name: named.chroot), сценарий проверяет какой из них активирован. Выводя состояние для каждого режима: <span style="color:orange">ENABLE</span> и <span style="color:orange">DISABLE</span>. Выполняет проверки: запущен ли сервис, валидность синтаксиса файлов конфигурации, валидность файлов зон. Выводя состояние для каждой проверки: <span style="color:green">PASS</span> и <span style="color:red">INVALID</span>. Выводи 7 последних сообщений из системного журнала.
   
   2.1 Сервис запещен и работает, ошибок не зафиксировано
   ![Work](images/named-work.gif)
   Необходимо выполнить [разрешение имен](#3).

   2.2 Сервис запущен, но есть ошибки в синтаксисе файлов конфигурации
   ![Invalid](images/named-invalid.gif)
   Необходимо запустить [сбор диагностической информации](#4) и сообщить об этом ответственным администраторам.

   2.3 Сервис остановлен
   ![stoped](images/named-stoped.gif)
   Необходимо выполнить запуск сервиса.

### 3. Проверка разрешения имен

Для проверки используется программа `nslookup`, в качестве аргументов необходимо передать: тип запроса, разрешаемое имя, сервер системы имен (DNS). Перед началом проверки необходимо сбросить DNS кеш на клиенте, выполнив команду:

!!! example inline "Для Windows"
    ``` console
    ipconfig \flushdns
    ```

!!! example inline end "Для Linux"
    ``` console
    sudo systemctl restart nscd.service
    ```

Выполнить разрешение имен:

!!! example "Разрешения имен"
    ``` console
    nslookup -type=any <имя_записи> <ip_сервера>
    ```

Если ответ не получен или содержит не верные данные, необходимо сбросить кеш на сервере.

### 4. Сбор диагностической информации

![Sosreport](images/sos.gif)

## Устранение сбоя
